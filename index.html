<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonicalc - Calculadora de Bonificaciones Hipotecarias</title>
    <meta name="description" content="Descubre si te conviene la hipoteca bonificada del banco o contratar los productos por tu cuenta. Calculadora gratuita de bonificaciones hipotecarias.">
    <meta name="keywords" content="hipoteca, bonificaciones, calculadora, banco, seguros, ahorro">
    <meta name="author" content="Bonicalc">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Bonicalc - ¬øTe convienen las bonificaciones de tu hipoteca?">
    <meta property="og:description" content="Calcula si realmente ahorras con la hipoteca bonificada o si pagas de m√°s por los productos del banco.">
    <meta property="og:image" content="https://bonicalc.com/preview.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Bonicalc - Calculadora de Bonificaciones Hipotecarias">
    <meta property="twitter:description" content="Descubre si las bonificaciones de tu hipoteca realmente te convienen.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-card {
            transition: all 0.3s ease;
        }
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        @media print {
            .no-print { display: none; }
            body { background: white; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
    <div class="max-w-7xl mx-auto p-4">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-8 text-white">
                <div class="flex items-center gap-3 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="4" y="2" width="16" height="20" rx="2"></rect>
                        <path d="M8 6h8"></path>
                        <path d="M8 10h8"></path>
                        <path d="M8 14h8"></path>
                        <path d="M8 18h6"></path>
                    </svg>
                    <h1 class="text-3xl font-bold">Bonicalc</h1>
                </div>
                <p class="text-blue-100 text-lg">
                    Descubre hasta qu√© a√±o te conviene mantener las bonificaciones de tu hipoteca
                </p>
            </div>

            <!-- Formulario -->
            <div class="p-8">
                <!-- Datos b√°sicos -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div class="space-y-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            Datos de tu hipoteca
                        </h2>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Capital pendiente (‚Ç¨)
                            </label>
                            <input
                                type="number"
                                id="capitalPendiente"
                                value="150000"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                                placeholder="150000"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Plazo restante (a√±os)
                            </label>
                            <input
                                type="number"
                                id="plazoRestante"
                                value="25"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                                placeholder="25"
                            />
                        </div>
                    </div>

                    <div class="space-y-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M15 9.354a4 4 0 1 0 0 5.292"></path>
                            </svg>
                            Tipo de inter√©s base
                        </h2>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Tipo de inter√©s SIN bonificar (%)
                            </label>
                            <input
                                type="number"
                                id="tipoBase"
                                step="0.01"
                                value="3.5"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                                placeholder="3.5"
                            />
                        </div>

                        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                            <p class="text-sm font-semibold text-blue-900 mb-1">Tipo de inter√©s con bonificaciones activas:</p>
                            <p class="text-2xl font-bold text-blue-600" id="tipoFinal">3.50%</p>
                            <p class="text-xs text-blue-700 mt-1">Bonificaci√≥n total: <span id="bonificacionTotal">0.00%</span></p>
                        </div>
                    </div>
                </div>

                <!-- Info sobre bonificaciones -->
                <div class="mb-6 p-4 bg-amber-50 rounded-lg">
                    <p class="text-sm text-amber-800">
                        <strong>üí° Consejo:</strong> Introduce las bonificaciones que te ofrece tu banco. Cada banco tiene diferentes porcentajes. 
                        Por ejemplo: n√≥mina 0.50%, seguros 0.25%-0.30%, tarjetas 0.10%-0.20%, etc.
                    </p>
                </div>

                <!-- Comparador de productos con bonificaciones -->
                <div class="mt-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Productos vinculados y sus bonificaciones
                    </h2>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2 border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Producto</th>
                                    <th class="text-center py-3 px-4 font-semibold text-gray-700">Activo</th>
                                    <th class="text-center py-3 px-4 font-semibold text-gray-700">
                                        <div class="flex items-center justify-center gap-1">
                                            <span>Bonificaci√≥n</span>
                                            <span class="text-xs text-gray-500">(%)</span>
                                        </div>
                                    </th>
                                    <th class="text-center py-3 px-4 font-semibold text-gray-700">
                                        <div class="flex items-center justify-center gap-1">
                                            <span>Coste banco</span>
                                            <span class="text-xs text-gray-500">(‚Ç¨/a√±o)</span>
                                        </div>
                                    </th>
                                    <th class="text-center py-3 px-4 font-semibold text-gray-700">
                                        <div class="flex items-center justify-center gap-1">
                                            <span>Coste externo</span>
                                            <span class="text-xs text-gray-500">(‚Ç¨/a√±o)</span>
                                        </div>
                                    </th>
                                    <th class="text-center py-3 px-4 font-semibold text-gray-700">Sobrecoste</th>
                                </tr>
                            </thead>
                            <tbody id="productosBody">
                                <!-- Se llenar√° con JavaScript -->
                            </tbody>
                            <tfoot>
                                <tr class="border-t-2 border-gray-300 bg-gray-50">
                                    <td class="py-4 px-4 font-semibold text-gray-700">TOTAL ANUAL</td>
                                    <td></td>
                                    <td class="text-center py-4 px-4 font-bold text-green-600" id="totalBonificacion">0.00%</td>
                                    <td class="text-center py-4 px-4 font-bold text-gray-900" id="totalBanco">0‚Ç¨</td>
                                    <td class="text-center py-4 px-4 font-bold text-gray-900" id="totalExterno">0‚Ç¨</td>
                                    <td class="text-center py-4 px-4 font-bold" id="totalDiferencia">0‚Ç¨</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Resultados -->
                <div id="resultados" class="mt-8 space-y-6 hidden">
                    <!-- Se llenar√° con JavaScript -->
                </div>

                <!-- Gr√°fico de evoluci√≥n -->
                <div id="graficoContainer" class="mt-8 hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        Evoluci√≥n del ahorro/p√©rdida a√±o a a√±o
                    </h2>
                    <div class="bg-gray-50 rounded-xl p-6">
                        <canvas id="graficoEvolucion" width="400" height="200"></canvas>
                        <div class="mt-4 flex items-center justify-center gap-6 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-500 rounded"></div>
                                <span>Per√≠odo rentable</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-red-500 rounded"></div>
                                <span>Per√≠odo no rentable</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-1 h-4 bg-yellow-600"></div>
                                <span>A√±o de inflexi√≥n</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="mt-12 pt-8 border-t border-gray-200 text-center text-sm text-gray-600 no-print">
                    <p>
                        üí° <strong>Bonicalc</strong> - Calculadora gratuita de bonificaciones hipotecarias
                    </p>
                    <p class="mt-2">
                        Creado con ‚ù§Ô∏è para todos los hipotecados
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datos de productos con bonificaciones editables
        const productos = {
            nomina: { 
                nombre: 'Domiciliaci√≥n de n√≥mina', 
                bonificacion: 0.5,
                banco: 0, 
                externo: 0, 
                activo: true, 
                icono: 'wallet' 
            },
            seguroHogar: { 
                nombre: 'Seguro de hogar', 
                bonificacion: 0.25,
                banco: 300, 
                externo: 200, 
                activo: true, 
                icono: 'shield' 
            },
            seguroVida: { 
                nombre: 'Seguro de vida', 
                bonificacion: 0.25,
                banco: 400, 
                externo: 250, 
                activo: true, 
                icono: 'shield' 
            },
            tarjetas: { 
                nombre: 'Tarjetas y uso m√≠nimo', 
                bonificacion: 0.15,
                banco: 60, 
                externo: 0, 
                activo: true, 
                icono: 'credit-card' 
            },
            planPensiones: { 
                nombre: 'Plan de pensiones/fondos', 
                bonificacion: 0.10,
                banco: 120, 
                externo: 120, 
                activo: false, 
                icono: 'wallet' 
            },
            cuenta: { 
                nombre: 'Cuenta sin comisiones', 
                bonificacion: 0.10,
                banco: 0, 
                externo: 0, 
                activo: false, 
                icono: 'wallet' 
            },
            recibos: { 
                nombre: 'Domiciliaci√≥n de recibos', 
                bonificacion: 0.05,
                banco: 0, 
                externo: 0, 
                activo: false, 
                icono: 'file' 
            },
            otros: { 
                nombre: 'Otros productos', 
                bonificacion: 0.10,
                banco: 100, 
                externo: 50, 
                activo: false, 
                icono: 'dollar-sign' 
            }
        };

        let chartInstance = null;

        // Funci√≥n para calcular la cuota mensual
        function calcularCuotaMensual(capital, plazoAnos, tipoInteres) {
            const meses = plazoAnos * 12;
            const interesMensual = tipoInteres / 100 / 12;
            
            if (interesMensual === 0) return capital / meses;
            
            const cuota = capital * (interesMensual * Math.pow(1 + interesMensual, meses)) / 
                          (Math.pow(1 + interesMensual, meses) - 1);
            
            return cuota;
        }

        // Funci√≥n para calcular el desglose de una cuota
        function calcularDesgloseCuota(capitalPendiente, cuotaMensual, tipoInteres) {
            const interesMensual = tipoInteres / 100 / 12;
            const intereses = capitalPendiente * interesMensual;
            const amortizacion = cuotaMensual - intereses;
            return { intereses, amortizacion };
        }

        // Funci√≥n para formatear n√∫meros
        function formatNumber(num, decimals = 2) {
            return num.toLocaleString('es-ES', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }

        // Funci√≥n para actualizar el tipo de inter√©s final
        function actualizarTipoFinal() {
            const tipoBase = Number(document.getElementById('tipoBase').value) || 0;
            let bonificacionTotal = 0;
            
            Object.values(productos).forEach(producto => {
                if (producto.activo) {
                    bonificacionTotal += producto.bonificacion;
                }
            });
            
            const tipoFinal = Math.max(0, tipoBase - bonificacionTotal);
            
            document.getElementById('tipoFinal').textContent = formatNumber(tipoFinal) + '%';
            document.getElementById('bonificacionTotal').textContent = formatNumber(bonificacionTotal) + '%';
            document.getElementById('totalBonificacion').textContent = formatNumber(bonificacionTotal) + '%';
            
            return { tipoBase, tipoFinal, bonificacionTotal };
        }

        // Funci√≥n para actualizar la tabla de productos
        function actualizarTablaProductos() {
            const tbody = document.getElementById('productosBody');
            tbody.innerHTML = '';
            
            Object.entries(productos).forEach(([key, producto]) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100 hover:bg-gray-50';
                
                const diferencia = producto.banco - producto.externo;
                
                tr.innerHTML = `
                    <td class="py-4 px-4">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-gray-700">${producto.nombre}</span>
                        </div>
                    </td>
                    <td class="text-center py-4 px-4">
                        <input
                            type="checkbox"
                            ${producto.activo ? 'checked' : ''}
                            onchange="toggleProducto('${key}')"
                            class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                        />
                    </td>
                    <td class="text-center py-4 px-4">
                        <input
                            type="number"
                            step="0.01"
                            value="${producto.bonificacion}"
                            onchange="actualizarProducto('${key}', 'bonificacion', this.value)"
                            ${!producto.activo ? 'disabled' : ''}
                            class="w-20 px-2 py-1 border rounded text-center ${
                                producto.activo 
                                    ? 'border-green-300 focus:ring-2 focus:ring-green-500 bg-green-50' 
                                    : 'border-gray-200 bg-gray-100 text-gray-400'
                            }"
                        />
                    </td>
                    <td class="text-center py-4 px-4">
                        <input
                            type="number"
                            value="${producto.banco}"
                            onchange="actualizarProducto('${key}', 'banco', this.value)"
                            ${!producto.activo ? 'disabled' : ''}
                            class="w-24 px-2 py-1 border rounded text-center ${
                                producto.activo 
                                    ? 'border-gray-300 focus:ring-2 focus:ring-blue-500' 
                                    : 'border-gray-200 bg-gray-100 text-gray-400'
                            }"
                        />
                    </td>
                    <td class="text-center py-4 px-4">
                        <input
                            type="number"
                            value="${producto.externo}"
                            onchange="actualizarProducto('${key}', 'externo', this.value)"
                            ${!producto.activo ? 'disabled' : ''}
                            class="w-24 px-2 py-1 border rounded text-center ${
                                producto.activo 
                                    ? 'border-gray-300 focus:ring-2 focus:ring-blue-500' 
                                    : 'border-gray-200 bg-gray-100 text-gray-400'
                            }"
                        />
                    </td>
                    <td class="text-center py-4 px-4">
                        ${producto.activo ? `
                            <span class="font-semibold ${diferencia > 0 ? 'text-red-600' : 'text-green-600'}">
                                ${diferencia > 0 ? '+' : ''}${diferencia}‚Ç¨
                            </span>
                        ` : ''}
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            actualizarTipoFinal();
            calcular();
        }

        // Funci√≥n para toggle producto
        function toggleProducto(key) {
            productos[key].activo = !productos[key].activo;
            actualizarTablaProductos();
        }

        // Funci√≥n para actualizar producto
        function actualizarProducto(key, campo, valor) {
            productos[key][campo] = Number(valor);
            actualizarTablaProductos();
        }

        // Funci√≥n para calcular a√±o por a√±o
        function calcularEvolucionAnual(capitalInicial, plazoAnos, tipoSinBonificar, tipoBonificado, costeAnualBanco, costeAnualExterno) {
            const evolucion = [];
            let capitalRestanteSinBonificar = capitalInicial;
            let capitalRestanteBonificado = capitalInicial;
            let ahorroAcumulado = 0;
            let anioInflexion = null;
            
            const cuotaSinBonificar = calcularCuotaMensual(capitalInicial, plazoAnos, tipoSinBonificar);
            const cuotaBonificada = calcularCuotaMensual(capitalInicial, plazoAnos, tipoBonificado);
            
            for (let ano = 1; ano <= plazoAnos; ano++) {
                let interesesAnualesSinBonificar = 0;
                let interesesAnualesBonificados = 0;
                
                // Calcular mes a mes
                for (let mes = 1; mes <= 12; mes++) {
                    // Sin bonificar
                    const desgloseSin = calcularDesgloseCuota(capitalRestanteSinBonificar, cuotaSinBonificar, tipoSinBonificar);
                    interesesAnualesSinBonificar += desgloseSin.intereses;
                    capitalRestanteSinBonificar -= desgloseSin.amortizacion;
                    
                    // Con bonificaci√≥n
                    const desgloseCon = calcularDesgloseCuota(capitalRestanteBonificado, cuotaBonificada, tipoBonificado);
                    interesesAnualesBonificados += desgloseCon.intereses;
                    capitalRestanteBonificado -= desgloseCon.amortizacion;
                }
                
                // Calcular ahorro/p√©rdida del a√±o
                const ahorroInteresesAno = interesesAnualesSinBonificar - interesesAnualesBonificados;
                const sobrecosteProductosAno = costeAnualBanco - costeAnualExterno;
                const balanceAno = ahorroInteresesAno - sobrecosteProductosAno;
                
                ahorroAcumulado += balanceAno;
                
                // Detectar a√±o de inflexi√≥n
                if (anioInflexion === null && balanceAno < 0) {
                    anioInflexion = ano;
                }
                
                evolucion.push({
                    ano,
                    capitalRestante: capitalRestanteBonificado,
                    interesesSinBonificar: interesesAnualesSinBonificar,
                    interesesBonificados: interesesAnualesBonificados,
                    ahorroIntereses: ahorroInteresesAno,
                    sobrecosteProductos: sobrecosteProductosAno,
                    balanceAno,
                    ahorroAcumulado
                });
            }
            
            return { evolucion, anioInflexion };
        }

        // Funci√≥n principal de c√°lculo
        function calcular() {
            const capitalPendiente = Number(document.getElementById('capitalPendiente').value);
            const plazoRestante = Number(document.getElementById('plazoRestante').value);
            const { tipoBase, tipoFinal } = actualizarTipoFinal();
            
            if (!capitalPendiente || !plazoRestante || !tipoBase) return;
            
            // Calcular costes anuales de productos
            let costeAnualBanco = 0;
            let costeAnualExterno = 0;
            
            Object.values(productos).forEach(producto => {
                if (producto.activo) {
                    costeAnualBanco += producto.banco;
                    costeAnualExterno += producto.externo;
                }
            });
            
            // Actualizar totales en la tabla
            document.getElementById('totalBanco').textContent = formatNumber(costeAnualBanco, 0) + '‚Ç¨';
            document.getElementById('totalExterno').textContent = formatNumber(costeAnualExterno, 0) + '‚Ç¨';
            const totalDiferencia = costeAnualBanco - costeAnualExterno;
            document.getElementById('totalDiferencia').innerHTML = `
                <span class="${totalDiferencia > 0 ? 'text-red-600' : 'text-green-600'}">
                    ${totalDiferencia > 0 ? '+' : ''}${formatNumber(totalDiferencia, 0)}‚Ç¨
                </span>
            `;
            
            // Calcular evoluci√≥n anual
            const { evolucion, anioInflexion } = calcularEvolucionAnual(
                capitalPendiente, 
                plazoRestante, 
                tipoBase, 
                tipoFinal, 
                costeAnualBanco, 
                costeAnualExterno
            );
            
            // Calcular totales
            const ultimoAno = evolucion[evolucion.length - 1];
            const ahorroTotal = ultimoAno.ahorroAcumulado;
            const esRentable = ahorroTotal > 0;
            
            // Mostrar resultados
            mostrarResultados({
                capitalPendiente,
                plazoRestante,
                tipoBase,
                tipoFinal,
                costeAnualBanco,
                costeAnualExterno,
                ahorroTotal,
                esRentable,
                evolucion,
                anioInflexion,
                totalDiferencia
            });
            
            // Mostrar gr√°fico
            mostrarGrafico(evolucion, anioInflexion);
        }

        // Funci√≥n para mostrar el gr√°fico mejorado
        function mostrarGrafico(evolucion, anioInflexion) {
            const container = document.getElementById('graficoContainer');
            container.classList.remove('hidden');
            
            const ctx = document.getElementById('graficoEvolucion').getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Preparar las anotaciones
            const annotations = {
                line0: {
                    type: 'line',
                    yMin: 0,
                    yMax: 0,
                    borderColor: 'rgb(0, 0, 0)',
                    borderWidth: 1,
                    borderDash: [5, 5]
                }
            };
            
            // A√±adir l√≠nea de inflexi√≥n si existe
            if (anioInflexion) {
                annotations.lineInflexion = {
                    type: 'line',
                    xMin: anioInflexion - 1,
                    xMax: anioInflexion - 1,
                    borderColor: 'rgb(245, 158, 11)',
                    borderWidth: 3,
                    borderDash: [8, 4],
                    label: {
                        enabled: true,
                        content: `A√±o ${anioInflexion}: Punto de inflexi√≥n`,
                        position: 'start',
                        backgroundColor: 'rgba(245, 158, 11, 0.9)',
                        color: 'white',
                        padding: 6,
                        borderRadius: 4,
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                };
                
                // A√±adir √°rea sombreada despu√©s del a√±o de inflexi√≥n
                annotations.boxNoRentable = {
                    type: 'box',
                    xMin: anioInflexion - 1,
                    xMax: evolucion.length,
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderColor: 'transparent',
                    borderWidth: 0
                };
            }
            
            // Crear colores din√°micos para el balance anual
            const coloresBalanceAnual = evolucion.map(e => e.balanceAno >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)');
            const bordeBalanceAnual = evolucion.map(e => e.balanceAno >= 0 ? 'rgb(16, 185, 129)' : 'rgb(239, 68, 68)');
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: evolucion.map(e => `A√±o ${e.ano}`),
                    datasets: [
                        {
                            label: 'Balance anual',
                            data: evolucion.map(e => e.balanceAno),
                            borderColor: bordeBalanceAnual,
                            backgroundColor: coloresBalanceAnual,
                            segment: {
                                borderColor: ctx => {
                                    const idx = ctx.p0DataIndex;
                                    return evolucion[idx].balanceAno >= 0 ? 'rgb(16, 185, 129)' : 'rgb(239, 68, 68)';
                                }
                            },
                            tension: 0.3,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: ctx => {
                                const value = ctx.parsed.y;
                                return value >= 0 ? 'rgb(16, 185, 129)' : 'rgb(239, 68, 68)';
                            }
                        },
                        {
                            label: 'Ahorro acumulado',
                            data: evolucion.map(e => e.ahorroAcumulado),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            borderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y;
                                    label += value >= 0 ? '+' : '';
                                    label += value.toLocaleString('es-ES', { maximumFractionDigits: 0 }) + '‚Ç¨';
                                    
                                    // A√±adir informaci√≥n adicional para el a√±o de inflexi√≥n
                                    if (anioInflexion && context.dataIndex === anioInflexion - 1) {
                                        label += ' (Punto de inflexi√≥n)';
                                    }
                                    
                                    return label;
                                }
                            }
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('es-ES') + '‚Ç¨';
                                }
                            },
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return 'rgba(0, 0, 0, 0.2)';
                                    }
                                    return 'rgba(0, 0, 0, 0.05)';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Funci√≥n para mostrar resultados
        function mostrarResultados(resultados) {
            const divResultados = document.getElementById('resultados');
            divResultados.classList.remove('hidden');
            
            // Encontrar el mejor momento para cancelar
            let mejorMomento = '';
            if (resultados.anioInflexion) {
                mejorMomento = `
                    <div class="mt-4 p-4 bg-yellow-100 rounded-lg border-2 border-yellow-300">
                        <p class="text-sm text-yellow-800">
                            <strong>‚è∞ Momento √≥ptimo para cancelar bonificaciones:</strong>
                        </p>
                        <p class="text-lg font-semibold text-yellow-900 mt-2">
                            A√±o ${resultados.anioInflexion} de tu hipoteca
                        </p>
                        <p class="text-sm text-yellow-700 mt-1">
                            A partir de este momento, el ahorro en intereses ser√° menor que el sobrecoste de los productos.
                        </p>
                    </div>
                `;
            } else if (resultados.esRentable) {
                mejorMomento = `
                    <div class="mt-4 p-4 bg-green-100 rounded-lg">
                        <p class="text-sm text-green-800">
                            <strong>‚úÖ Mant√©n las bonificaciones durante toda la hipoteca</strong><br>
                            El ahorro en intereses siempre supera el sobrecoste de los productos.
                        </p>
                    </div>
                `;
            }
            
            divResultados.innerHTML = `
                <!-- Alerta principal -->
                <div class="fade-in p-6 rounded-xl ${resultados.esRentable 
                    ? 'bg-green-50 border-2 border-green-200' 
                    : 'bg-red-50 border-2 border-red-200'}">
                    <div class="flex items-start gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${resultados.esRentable ? 'text-green-600' : 'text-red-600'}">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold mb-2 ${resultados.esRentable ? 'text-green-800' : 'text-red-800'}">
                                ${resultados.esRentable 
                                    ? '‚úÖ Las bonificaciones S√ç te convienen (en general)' 
                                    : '‚ùå Las bonificaciones NO te convienen'}
                            </h3>
                            <p class="${resultados.esRentable ? 'text-green-700' : 'text-red-700'}">
                                ${resultados.esRentable 
                                    ? `Ahorrar√°s ${formatNumber(resultados.ahorroTotal, 0)}‚Ç¨ durante toda la vida del pr√©stamo`
                                    : `Perder√°s ${formatNumber(Math.abs(resultados.ahorroTotal), 0)}‚Ç¨ durante toda la vida del pr√©stamo`}
                            </p>
                            ${mejorMomento}
                        </div>
                    </div>
                </div>

                <!-- Tabla de evoluci√≥n a√±o a a√±o -->
                <div class="mt-6 bg-gray-50 rounded-xl p-6">
                    <h4 class="font-semibold text-gray-800 mb-4">Evoluci√≥n a√±o a a√±o (primeros 10 a√±os)</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-300">
                                    <th class="text-left py-2 px-3">A√±o</th>
                                    <th class="text-right py-2 px-3">Ahorro intereses</th>
                                    <th class="text-right py-2 px-3">Sobrecoste productos</th>
                                    <th class="text-right py-2 px-3">Balance anual</th>
                                    <th class="text-right py-2 px-3">Acumulado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${resultados.evolucion.slice(0, 10).map(e => `
                                    <tr class="border-b border-gray-200 ${e.balanceAno < 0 ? 'bg-red-50' : ''} ${resultados.anioInflexion && e.ano === resultados.anioInflexion ? 'bg-yellow-50 font-semibold' : ''}">
                                        <td class="py-2 px-3">
                                            ${e.ano}
                                            ${resultados.anioInflexion && e.ano === resultados.anioInflexion ? '<span class="text-yellow-600 text-xs ml-1">‚ö†Ô∏è</span>' : ''}
                                        </td>
                                        <td class="text-right py-2 px-3 text-green-600">+${formatNumber(e.ahorroIntereses, 0)}‚Ç¨</td>
                                        <td class="text-right py-2 px-3 text-red-600">-${formatNumber(e.sobrecosteProductos, 0)}‚Ç¨</td>
                                        <td class="text-right py-2 px-3 font-semibold ${e.balanceAno >= 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${e.balanceAno >= 0 ? '+' : ''}${formatNumber(e.balanceAno, 0)}‚Ç¨
                                        </td>
                                        <td class="text-right py-2 px-3 font-semibold ${e.ahorroAcumulado >= 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${e.ahorroAcumulado >= 0 ? '+' : ''}${formatNumber(e.ahorroAcumulado, 0)}‚Ç¨
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${resultados.evolucion.length > 10 ? `
                        <p class="text-xs text-gray-600 mt-2">Se muestran los primeros 10 a√±os. Ver gr√°fico completo abajo.</p>
                    ` : ''}
                </div>

                <!-- Informaci√≥n adicional -->
                <div class="mt-6 p-4 bg-amber-100 rounded-lg">
                    <p class="text-sm text-amber-800">
                        <strong>üí° Clave:</strong> El ahorro en intereses es mayor los primeros a√±os porque el capital pendiente es m√°s alto. 
                        Con el tiempo, este ahorro disminuye mientras que el coste de los productos se mantiene constante.
                    </p>
                </div>

                <!-- Bot√≥n para imprimir -->
                <div class="text-center mt-6 no-print">
                    <button onclick="window.print()" class="inline-flex items-center gap-2 px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 6 2 18 2 18 9"></polyline>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <rect x="6" y="14" width="12" height="8"></rect>
                        </svg>
                        Imprimir resultados
                    </button>
                </div>
            `;
        }

        // Event listeners
        document.getElementById('capitalPendiente').addEventListener('input', calcular);
        document.getElementById('plazoRestante').addEventListener('input', calcular);
        document.getElementById('tipoBase').addEventListener('input', () => {
            actualizarTipoFinal();
            calcular();
        });

        // Inicializar
        actualizarTablaProductos();
    </script>
</body>
</html>
